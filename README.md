# MetaNovel-Engine

![Version](https://img.shields.io/badge/version-v0.0.6-blue.svg)
![Python](https://img.shields.io/badge/python-3.8+-green.svg)
![License](https://img.shields.io/badge/license-MIT-yellow.svg)

> AI辅助小说创作引擎 - 结构化、分阶段的长篇小说创作工具链

## 📖 项目简介

MetaNovel-Engine 是一套完整的AI辅助小说创作工具链，通过结构化的7步流程，帮助作家从一个简单的想法逐步扩展为完整的小说作品。采用JSON格式存储各阶段数据，有效节省上下文tokens、降低AI幻觉率，以工程化方式打磨故事。

### 🎯 核心优势

- **🏗️ 模块化架构**：清晰的代码结构，易于维护和功能扩展
- **📁 多项目管理**：支持同时管理多个小说项目，完全独立的数据存储
- **🎯 渐进式创作**：7个步骤层层递进，从主题构思到完整小说
- **🤖 智能AI辅助**：支持多种大语言模型，智能重试和异步并发
- **📊 结构化管理**：JSON格式存储，完整的CRUD操作
- **⚡ 高性能**：异步处理实现4-5倍速度提升
- **🎮 友好界面**：现代化CLI界面，实时进度显示

## 🚀 快速开始

### 环境要求
- Python 3.8+
- OpenRouter API密钥

### 安装步骤

1. **克隆并安装**
   ```bash
   git clone https://github.com/hahagood/MetaNovel-Engine.git
   cd MetaNovel-Engine
   pip install -r requirements.txt
   ```

2. **配置API密钥**
   ```bash
   # 复制环境变量模板
   # Linux/macOS:
   cp .env.example .env
   # Windows:
   copy .env.example .env
   
   # 编辑.env文件，填入你的API密钥
   nano .env
   ```

   **.env文件示例：**
   ```bash
   OPENROUTER_API_KEY=your_api_key_here
   HTTP_PROXY=http://127.0.0.1:7890  # 可选：代理配置
   HTTPS_PROXY=http://127.0.0.1:7890
   ```

3. **数据迁移（如果有旧版本数据）**
   ```bash
   # 如果您之前使用过单项目版本，需要先运行迁移工具
   python migrate_to_multi_project.py
   ```

4. **运行程序**
   ```bash
   python meta_novel_cli.py
   ```

## 📝 创作流程

### 7步渐进式创作工作流

| 步骤 | 功能 | 说明 |
|------|------|------|
| 1️⃣ | **设置小说名称与主题** | 设置小说名称，确立一句话主题（主菜单动态显示小说名） |
| 2️⃣ | **扩展成段落主题** | 将核心理念扩展为详细描述 |
| 3️⃣ | **世界设定** | 创建角色、场景、道具的完整世界观 |
| 4️⃣ | **编辑故事大纲** | 500-800字的详细故事框架 |
| 5️⃣ | **编辑分章细纲** | 分解为5-10个章节的详细大纲 |
| 6️⃣ | **编辑章节概要** | 每章节300-500字的详细概要 |
| 7️⃣ | **生成小说正文** | 2000-4000字的完整章节正文，支持分章节导出 |

### 世界设定管理

- **👥 角色管理**：创建和管理小说中的重要人物
- **🏛️ 场景管理**：设计故事发生的重要地点和环境  
- **⚔️ 道具管理**：定义关键物品、武器、神器等元素

每个步骤都支持完整的查看、编辑、删除操作，程序会自动检查前置条件，确保创作流程的完整性。

## 📁 项目结构

```
MetaNovel-Engine/
├── 🗂️ 应用数据目录/              # 多项目管理目录（跨平台自适应）
│   ├── config.json             # 全局配置文件
│   └── projects/               # 项目存储目录
│       ├── 项目1/
│       │   ├── meta/           # 项目1的创作数据
│       │   └── meta_backup/    # 项目1的备份数据
│       └── 项目2/
│           ├── meta/           # 项目2的创作数据
│           └── meta_backup/    # 项目2的备份数据
├── 🗂️ 用户文档目录/              # 导出文件存储目录（可配置）
│   └── MetaNovel/              # 默认导出基础目录
│       ├── 项目1/              # 项目1的导出文件
│       └── 项目2/              # 项目2的导出文件
├── 🗂️ tests/                   # 单元测试
├── 🔧 config.py                # 配置管理模块
├── 💾 data_manager.py          # 数据管理模块
├── 📁 project_manager.py       # 项目管理模块
├── 🎯 project_data_manager.py  # 项目数据管理器
├── 🎨 project_ui.py            # 项目管理界面
├── 🤖 llm_service.py           # AI服务模块
├── 🔄 retry_utils.py           # 智能重试工具
├── 📊 progress_utils.py        # 进度显示工具
├── 📝 prompts.json             # AI提示词配置
├── 🎮 meta_novel_cli.py        # 主程序
├── 🚀 migrate_to_multi_project.py # 数据迁移工具
└── 🧪 run_tests.py             # 测试运行脚本
```

### 跨平台数据存储

MetaNovel-Engine 支持跨平台数据存储，自动适配不同操作系统的标准应用数据目录：

| 操作系统 | 数据存储路径 |
|----------|-------------|
| 🐧 Linux | `~/.metanovel/` |
| 🍎 macOS | `~/Library/Application Support/MetaNovel/` |
| 🪟 Windows | `%LOCALAPPDATA%/MetaNovel/` |

### 模块说明

| 模块 | 功能 |
|------|------|
| `config.py` | 统一配置管理，包含AI模型、网络代理、重试机制等配置 |
| `data_manager.py` | 数据层抽象，提供完整的CRUD操作接口 |
| `project_manager.py` | 多项目管理核心，处理项目创建、切换、删除等操作 |
| `project_data_manager.py` | 项目感知的数据管理器工厂，统一管理多项目数据 |
| `project_ui.py` | 项目管理用户界面，提供友好的项目操作界面 |
| `llm_service.py` | AI服务封装，支持同步/异步调用和智能重试 |
| `retry_utils.py` | 智能重试机制，支持指数退避、错误分类和批量重试 |
| `progress_utils.py` | 进度显示系统，支持实时状态更新 |
| `migrate_to_multi_project.py` | 数据迁移工具，帮助用户从单项目模式迁移到多项目模式 |

## ⚙️ 配置说明

### API配置
- 支持OpenRouter平台的多种模型
- 默认使用`google/gemini-2.5-pro-preview-06-05`
- 通过系统设置可调整AI模型参数

### 网络代理配置
支持通过环境变量配置HTTP/HTTPS代理：

**方式1：在.env文件中配置（推荐，跨平台通用）**
```bash
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

**方式2：通过系统环境变量**

🐧 **Linux / macOS**
```bash
export HTTP_PROXY="http://127.0.0.1:7890"
export HTTPS_PROXY="http://127.0.0.1:7890"
```

🪟 **Windows (命令提示符)**
```cmd
set HTTP_PROXY=http://127.0.0.1:7890
set HTTPS_PROXY=http://127.0.0.1:7890
```

🪟 **Windows (PowerShell)**
```powershell
$env:HTTP_PROXY = "http://127.0.0.1:7890"
$env:HTTPS_PROXY = "http://127.0.0.1:7890"
```

**常见端口号：**
- Clash: 7890
- V2Ray: 1080, 8118  
- Shadowsocks: 1080

### 智能重试配置
- **最大重试次数**：1-10次，默认3次
- **基础延迟时间**：0.1-10秒，默认1.0秒
- **指数退避策略**：支持指数增长延迟时间
- **随机抖动**：避免同时重试造成服务器压力
- **错误分类**：自动识别可重试和不可重试的错误

### 导出路径配置
- **默认导出路径**：自动使用用户文档目录下的 `MetaNovel` 文件夹
- **自定义导出路径**：支持设置绝对路径或相对路径
- **路径验证**：自动验证路径有效性和写入权限
- **一键重置**：可快速重置为默认导出路径
- **用户友好**：导出文件保存在易于访问的位置，避免隐藏目录

## 🌟 功能特色

### 📁 多项目管理
- **项目工作台**：统一的项目管理界面，支持创建、切换、删除项目
- **独立存储**：每个项目的数据完全独立，存储在相应的项目目录下
- **跨平台兼容**：自动适配Windows、macOS、Linux的标准应用数据目录
- **智能切换**：快速在不同项目间切换，自动加载对应的数据管理器
- **项目详情**：显示项目信息、创作进度、完成状态等详细信息
- **数据迁移**：提供完整的旧版本数据迁移工具，无缝升级到多项目模式
- **灵活管理**：支持项目重命名、描述编辑、路径管理等功能

### 🧠 智能AI辅助
- **智能依赖检查**：每个步骤都会检查前置条件
- **上下文信息整合**：AI生成时自动整合所有相关信息，确保角色、场景、道具与故事背景一致
- **人性化AI提示**：从技巧导向转为人性导向，强调角色内在动机和心理逻辑
- **情感真实性**：避免刻意制造冲突，让矛盾从角色的不同立场和需求中自然产生
- **智能重试机制**：自动重试失败的AI请求
- **异步并发处理**：批量生成时实现4-5倍速度提升

### 🎮 用户体验
- **现代化CLI界面**：友好的命令行界面
- **实时进度显示**：可视化进度条、状态反馈、重试信息
- **智能项目进度**：详细的创作进度统计、完成度百分比、智能下一步建议
- **动态主菜单**：第一项动态显示当前小说名称，提供直观的创作状态
- **系统设置面板**：用户可自定义重试参数、AI模型配置
- **灵活的编辑功能**：支持对所有生成内容的查看、编辑、删除

### 📤 导出功能
- **智能文件命名**：小说名_章节范围_时间戳格式
- **可配置导出路径**：支持自定义导出位置，默认使用用户文档目录，用户友好易找
- **项目隔离存储**：每个项目在导出目录下创建独立文件夹，完全隔离管理
- **完整的元数据信息**：包含创作时间、字数统计、章节信息
- **灵活的导出选项**：
  - 导出完整小说（所有章节）
  - 导出单个章节（可选择特定章节）
  - 导出章节范围（自定义起始和结束章节）
- **跨平台路径管理**：自动适配不同操作系统的文件存储位置
- **路径配置选项**：
  - 默认路径：`~/Documents/MetaNovel/` (用户文档目录)
  - 自定义绝对路径：如 `/home/user/MyExports`
  - 自定义相对路径：如 `MyNovelExports` (相对于文档目录)

### ⚡ 性能与稳定性
- **模块化架构**：清晰的代码结构，易于维护和扩展
- **错误处理增强**：区分可重试和不可重试错误
- **批量操作优化**：支持批量生成和批量重试

## 🧪 测试与开发

### 运行测试
```bash
# 运行所有测试
python run_tests.py

# 运行特定模块测试
python -m pytest tests/test_data_manager.py -v
```

### 测试覆盖
- 配置模块测试
- 数据管理模块测试
- AI服务模块测试
- 实体管理模块测试

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

1. Fork本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启Pull Request

## 📋 开发路线图

### 🎯 短期目标
- [ ] 导出功能：支持多种格式（TXT、Word、PDF、ePub）
- [ ] 自动备份：定时备份、版本控制、恢复功能
- [ ] 模板系统：预设的小说类型模板

### 🔧 中期目标
- [ ] 多AI模型支持：Claude、GPT-4、Gemini等模型切换
- [ ] 创作进度跟踪：可视化创作进度、统计信息
- [ ] 智能建议：基于已有内容的智能创作建议

### 🚀 长期目标
- [ ] 图形界面：基于Tkinter或PyQt的GUI版本
- [ ] Web版本：基于Flask/FastAPI的Web界面
- [ ] 协作编辑：多人协作创作功能
- [ ] 云端同步：多设备间的项目同步

## 📄 许可证

本项目采用MIT License，详见[LICENSE](LICENSE)文件。

## 📝 版本历史

### v0.0.6 (2025-07-04) - 智能优化版本
- 🔧 **数据管理器路径修复**：解决世界设定数据保存到错误位置的问题
- 📊 **进度状态显示修复**：修复"世界设定已完成但仍显示尚未创建"的bug
- 🎭 **AI生成质量优化**：重新设计prompt策略，解决"刻意制造冲突缺乏动机"问题
- 🧠 **人性化AI提示**：从技巧导向转为人性导向，强调角色内在动机和心理逻辑
- ✨ **情感真实性增强**：避免套路化情节，关注角色行为的合理性和必然性
- 🎯 **上下文传递机制**：完善角色、场景、道具生成时的上下文信息整合
- 📚 **代码质量提升**：统一使用项目数据管理器，避免路径混乱

### v0.0.5 (2025-06-30) - 多项目管理版本
- 🚀 **多项目管理**：支持同时管理多个小说项目
- 📁 **项目工作台**：统一的项目管理界面，支持创建、切换、删除项目
- 🌍 **跨平台兼容**：自动适配Windows、macOS、Linux的标准应用数据目录
- 🔄 **数据迁移**：提供完整的旧版本数据迁移工具
- 🏗️ **架构升级**：项目感知的数据管理器，动态路径配置
- 📊 **项目详情**：详细的项目信息和创作进度跟踪
- 💾 **独立存储**：每个项目的数据完全独立，互不干扰
- 🎯 **智能切换**：快速在不同项目间切换，保持创作连续性

### v0.0.4 (2025-06-28) - 用户体验优化版本
- ✨ 主菜单第一项动态显示小说名称功能
- 📤 分章节导出功能：支持完整小说、单章节、章节范围导出
- 🎨 美化项目进度显示：详细统计、完成度百分比、智能建议
- 🔧 修复第七项图标冲突问题（改为📜图标）
- 📝 新增小说名称设置和管理功能
- 💾 优化数据格式兼容性，支持新旧数据结构

### v0.0.3 (2025-06-28) - 大师级精炼版本
- 🎯 数据模型升级：引入Pydantic提供类型安全和自动验证
- 🎨 界面美化升级：使用Rich库创建现代化命令行界面
- 🔧 代码质量提升：统一数据访问接口，减少重复代码
- 📚 文档和示例：提供完整的使用示例和API文档

### v0.0.2 (2025-06-27) - 模块化重构版本
- 🏗️ 模块化架构重构：从单一2700行文件拆分为8个独立模块
- ⚡ 异步并发处理：批量生成实现4-5倍速度提升
- 🔄 智能重试机制：自动重试失败的AI请求，支持指数退避
- 📊 实时进度显示：可视化进度条、状态反馈、重试信息
- 🔐 安全性增强：环境变量管理，配置验证，代理支持
- 🧪 完整测试体系：单元测试覆盖所有核心模块

### v0.0.1 (2025-06-19) - 原型版本
- 🎉 首个原型版本发布
- ✨ 实现完整的7步创作流程
- 🌍 支持世界设定管理（角色、场景、道具）
- 🤖 OpenRouter API集成

---

**开始您的AI辅助小说创作之旅吧！** 🚀
