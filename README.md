# MetaNovel-Engine

![Version](https://img.shields.io/badge/version-v0.0.14-blue.svg)
![Python](https://img.shields.io/badge/python-3.8+-green.svg)
![License](https://img.shields.io/badge/license-MIT-yellow.svg)

> AI辅助小说创作引擎 - 结构化、分阶段的长篇小说创作工具链

## 📖 项目简介

MetaNovel-Engine 是一套完整的AI辅助小说创作工具链，通过结构化的7步流程，帮助作家从一个简单的想法逐步扩展为完整的小说作品。它以工程化的方式，通过分阶段和结构化的数据管理，帮助你打磨故事，同时有效节省AI模型的开销。

## ✨ 核心功能

- **📁 多项目管理**：支持同时管理多个小说项目，数据完全独立。
- **🎨 项目级Prompts配置**：每个项目都有独立的prompts.json配置，支持个性化AI提示词。
- **🎯 渐进式创作**：7个步骤层层递进，从主题构思到完整小说。
- **🤖 智能AI辅助**：集成大语言模型，为创作的每一步提供灵感。
- **🌍 世界设定管理**：轻松管理你的角色、场景和关键道具。
- **🎮 友好界面**：现代化的CLI界面，提供清晰的指引和实时进度显示。
- **📤 灵活导出**：支持将整本小说或单个章节导出为文本文件。

## 🚀 快速开始

### 环境要求
- Python 3.8+
- OpenRouter API密钥

### 安装与运行

1.  **克隆并安装依赖**
    ```bash
    git clone https://github.com/hahagood/MetaNovel-Engine.git
    cd MetaNovel-Engine
    pip install -r requirements.txt
    ```

2.  **配置API密钥**
    将 `.env.example` 文件复制为 `.env`，然后填入你的API密钥。如果需要，也可以配置网络代理。
    ```bash
    # Linux/macOS:
    cp .env.example .env
    # Windows:
    copy .env.example .env

    # 编辑 .env 文件
    nano .env
    ```
    **.env 文件内容示例:**
    ```
    OPENROUTER_API_KEY=your_api_key_here
    HTTP_PROXY=http://127.0.0.1:7890
    ```

3.  **运行程序**
    ```bash
    python meta_novel_cli.py
    ```

4.  **数据迁移 (可选)**
    如果你是旧版本用户，请运行迁移工具来适配新的多项目结构。
    ```bash
    python migrate_to_multi_project.py
    ```

## 📝 创作流程：7步工作流

| 步骤 | 功能 | 说明 |
|------|------|------|
| 1️⃣ | **设置小说名称与主题** | 确立一句话核心主题 |
| 2️⃣ | **扩展成段落主题** | 将核心理念扩展为详细描述 |
| 3️⃣ | **世界设定** | 创建角色、场景、道具等世界观元素 |
| 4️⃣ | **编辑故事大纲** | 撰写500-800字的详细故事框架 |
| 5️⃣ | **编辑分章细纲** | 将故事分解为5-10个章节的细纲 |
| 6️⃣ | **编辑章节概要** | 为每章节编写300-500字的详细概要 |
| 7️⃣ | **生成小说正文** | 生成2000-4000字的完整章节 |

*每个步骤都支持查看、编辑和删除，程序会自动检查依赖，确保创作流程的连贯性。*

## ⚙️ 配置说明

你可以在程序内的 **"系统设置"** 菜单中调整以下常用配置：

- **AI模型**: 更换你偏好的语言模型。
- **智能重试**: 调整网络请求失败后的重试次数和延迟。
- **导出路径**: 自定义小说文件的导出位置（默认为用户文档目录下的 `MetaNovel` 文件夹）。

## 📄 许可证

本项目采用MIT License，详见[LICENSE](LICENSE)文件。

## 📝 版本历史

### v0.0.14 (2025-07-09) - 项目级Prompts配置
- **功能增强**:
  - 实现每个项目使用各自的prompts.json配置文件，实现真正的项目级AI提示词定制
  - 新项目会自动从根目录或默认模板复制prompts.json，确保配置完整性
  - 项目切换时自动重新加载对应的prompts配置，即时生效
- **技术改进**:
  - 修改LLMService类支持动态prompts路径获取和重新加载
  - 优化prompts_ui.py的路径管理逻辑，支持项目级别配置
  - 在project_data_manager中添加prompts自动重载机制
- **用户体验**:
  - 每个项目现在可以有完全独立的AI提示词配置
  - 支持针对不同类型小说（如科幻、言情、悬疑）使用不同的AI创作风格
  - 向后兼容单项目模式，不影响现有用户的使用体验

### v0.0.13 (2025-07-09) - 菜单交互优化
- **用户体验优化**:
  - 修复了所有菜单中选择"返回"时不必要的"按回车键继续..."提示
  - 统一了菜单返回行为，现在选择返回会直接返回上级菜单
  - 修复了实体管理器（角色、场景、道具）中的菜单返回问题
- **功能改进**:
  - 改进了项目详情查看功能，现在支持选择任意项目查看详情
  - 修复了查看角色详情时的索引错误导致的程序崩溃
  - 修复了project_data_manager.get_data_manager()调用错误
- **技术修复**:
  - 涉及的模块：workflow_ui.py、entity_manager.py、project_ui.py
  - 改善了用户操作的流畅性，减少了冗余的交互步骤

### v0.0.12 (2025-07-08) - 优雅退出功能
- **用户体验**:
  - 新增优雅的Ctrl+C退出处理功能，在任何菜单层级都能安全退出
  - Ctrl+C现在显示与菜单退出相同的友好退出界面，提供统一的退出体验
  - 新增signal_handler.py模块，专门处理系统信号
- **技术改进**:
  - 修改所有UI模块的循环函数，支持KeyboardInterrupt优雅处理
  - 在ui_utils.py中为所有输入函数添加信号处理
  - 新增测试脚本验证信号处理功能
- **开发质量**:
  - 确保程序在接收到中断信号时不会产生错误警告信息
  - 提高了程序的健壮性和用户体验

### v0.0.11 (2025-07-08) - 测试重构与UI优化
- **测试**:
  - 重构了整个测试套件，通过`patch`和`mock`实现了测试的完全隔离，解决了测试污染全局状态和残留文件的问题。
  - 修复了`test_data_manager`、`test_entity_manager`和`test_llm_service`中的多个长期存在的bug。
- **UI/UX**:
  - 优化了所有菜单的无效输入提示，使其措辞更友好，对齐更美观。
- **开发流程**:
  - 建立了严格的“分支-测试-合并”开发流程，确保所有代码修改都经过验证，提高了项目的整体稳定性。

### v0.0.10 (2025-07-08) - 稳定版发布与历史回滚
- **稳定性**: 回退并放弃了在 `v0.0.9` 之后引入的、导致程序崩溃或行为异常的所有不稳定改动，将版本稳定在 `6aa8825` 提交的基础上。这个版本被确认为当前最可靠的可用版本。
- **UI/UX 改进**:
  - 在查看章节细纲时，完整显示大纲内容，而不是截断的预览。
- **核心功能**: 
  - 实现了基本的项目创建、加载和管理框架。

### v0.0.9 (2025-07-07) - UI修复与流程优化
- 修复了因循环导入导致的 `NameError`，解决了在项目管理中继续创作时程序崩溃的问题。
- 全面修复了各级菜单中的重复编号和显示问题，统一了交互逻辑。
- 优化了实体管理、章节管理和项目编辑功能，使其更加稳定。

### v0.0.8 (2025-07-06) - UI交互重构
- 重构了整个应用的UI交互逻辑，统一了菜单的展现和操作方式。
- 改进了用户提示和输出格式，提高了界面的清晰度和一致性。
- 优化了项目切换流程，确保操作后能正确返回主菜单。

### v0.0.7 (2025-07-06) - 小说生成与菜单优化
- 优化小说正文生成提示词, 增加了反思和修正步骤。
- 优化了菜单结构, 统一了各级菜单的返回/退出逻辑。

### v0.0.6 (2025-07-04) - 智能优化版本
- 修复了数据存储和状态显示的bug。
- 优化了AI生成提示词，增强了情感真实性。

### v0.0.5 (2025-06-30) - 多项目管理版本
- 引入多项目管理功能，支持同时创作多部小说。
- 提供数据迁移工具，兼容旧版本数据。

### v0.0.4 (2025-06-28) - 用户体验优化
- 增加动态小说标题和分章节导出功能，优化了项目进度显示。

### v0.0.3 (2025-06-28) - 技术精炼
- 引入Pydantic和Rich库，提升了数据安全性和界面美观度。

### v0.0.2 (2025-06-27) - 模块化重构
- 完成项目模块化，引入异步处理和智能重试，大幅提升性能。

### v0.0.1 (2025-06-19) - 原型发布
- 项目原型发布，实现了核心的7步创作流程。

---

**开始您的AI辅助小说创作之旅吧！** 🚀